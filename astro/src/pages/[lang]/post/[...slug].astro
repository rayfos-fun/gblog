---
import { getCollection } from 'astro:content';
import BlogPostLayout from '@/layouts/PostLayout.astro'; // è«‹ç¢ºèªè·¯å¾‘æ˜¯å¦æ­£ç¢º

export async function getStaticPaths() {
  const posts = await getCollection('post');

  return posts.flatMap((post) => {
    const parts = post.slug.split('/');
    
    // 1. é˜²å‘†æ©Ÿåˆ¶ï¼šéæ¿¾æ‰ä¸åœ¨èªè¨€è³‡æ–™å¤¾å…§çš„æª”æ¡ˆ
    if (parts.length < 2) {
      console.warn(`âš ï¸ è·³éæª”æ¡ˆ (è·¯å¾‘éŒ¯èª¤): ${post.id}`);
      return [];
    }

    const lang = parts[0];
    const slug = parts.slice(1).join('/');

    return [{
      params: { 
        lang: lang, 
        slug: slug || undefined 
      },
      // 2. ã€é—œéµä¿®æ­£ã€‘é€™è£¡ä¸€å®šè¦ç”¨ props åŒ…èµ·ä¾†ï¼
      props: { post }, 
    }];
  });
}

// 3. æ¥æ”¶è³‡æ–™
const { post } = Astro.props; // å¦‚æœä¸Šé¢çš„ props æ²’å¯«å°ï¼Œé€™è£¡çš„ post å°±æœƒæ˜¯ undefined

// 4. é˜²å‘†æª¢æŸ¥ (å¦‚æœ post çœŸçš„æ²’æŠ“åˆ°ï¼Œç›´æ¥ä¸Ÿå‡ºéŒ¯èª¤ï¼Œä¸è¦ç­‰åˆ° render æ‰ç‚¸é–‹)
if (!post) {
  throw new Error(`âŒ åš´é‡éŒ¯èª¤ï¼šç¶²å€ ${Astro.url.pathname} æ‰¾ä¸åˆ°å°æ‡‰çš„æ–‡ç« è³‡æ–™ (post prop is missing)`);
}

// 5. æ¸²æŸ“å…§å®¹
const { Content } = await post.render(); // å‰›å‰›å ±éŒ¯å°±æ˜¯æ­»åœ¨é€™ä¸€è¡Œ
const { lang } = Astro.params;
---

<BlogPostLayout title={post.data.title} lang={lang}>
  <article class="max-w-4xl mx-auto">
    <header class="mb-10 text-center">
      <h1 class="text-4xl font-bold mb-4">{post.data.title}</h1>
      <div class="text-gray-500 flex justify-center gap-4 text-sm">
        <span>ğŸ“… {post.data.date.toISOString().slice(0, 10)}</span>
      </div>
    </header>
    <div class="divider"></div>
    <div class="prose prose-lg max-w-none prose-img:rounded-xl">
      <Content />
    </div>
  </article>
</BlogPostLayout>