---
import BaseLayout from '@/layouts/BaseLayout.astro';
import ContentCard from '@/components/ContentCard.astro';
import { getCollection } from 'astro:content';

export function getStaticPaths() {
  return [
    {params: {lang: 'zh-tw'}},
    {params: {lang: 'zh-cn'}},
    {params: {lang: 'en'}},
  ];
}

const { lang } = Astro.params;

const posts = await getCollection('posts');
const games = await getCollection('games');
const tools = await getCollection('tools');
const stories = await getCollection('stories');

// Helper to normalized items and filter by language
const normalizeItem = (item, type, basePath) => {
    // Determine language from ID (assuming folder structure like "zh-tw/...")
    // or slug
    const idParts = item.id.split('/');
    const itemLang = idParts[0];

    // Filter out items not matching current language
    if (itemLang !== lang) return null;

    const slugParts = item.slug.split('/');
    const cleanSlug = slugParts.length > 1 ? slugParts.slice(1).join('/') : item.slug;
    
    const routeType = type.toLowerCase();
    
    let url = '';
    if (lang === 'en') {
        url = `/${routeType}/${cleanSlug}`;
    } else {
        url = `/${lang}/${routeType}/${cleanSlug}`;
    }

    return {
        ...item.data,
        originalItem: item,
        type: type,
        dateObj: new Date(item.data.date),
        url: url
    };
};

const filterByLang = (collection, type, basePath) => {
    return collection
        .map(i => normalizeItem(i, type, basePath))
        .filter(i => i !== null);
};

const allItems = [
    ...filterByLang(posts, 'Post', 'posts'),
    ...filterByLang(games, 'Game', 'games'),
    ...filterByLang(tools, 'Tool', 'tools'),
    ...filterByLang(stories, 'Story', 'stories')
];

// Sort by date descending
allItems.sort((a, b) => b.dateObj - a.dateObj);

const latestUpdates = allItems.slice(0, 3);

// Get top 3 for each category
const getLatest = (collection, type) => {
    const items = filterByLang(collection, type, type.toLowerCase() + 's');
    items.sort((a, b) => b.dateObj - a.dateObj);
    return items.slice(0, 3);
};

const latestPosts = getLatest(posts, 'Post');
const latestGames = getLatest(games, 'Game');
const latestTools = getLatest(tools, 'Tool');
const latestStories = getLatest(stories, 'Story');

const pageTitle = "Home";
---

<BaseLayout pageTitle={pageTitle} lang={lang}>
    <div class="container mx-auto px-4 py-8">
        
        {/* Latest Updates Section */}
        <section class="mb-12">
            <h2 class="text-3xl font-bold mb-6 border-b pb-2">Latest Updates ({lang})</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {latestUpdates.map(item => (
                    <ContentCard
                        title={item.title}
                        date={item.date}
                        url={item.url}
                        description={`${item.type} - ${item.description || 'No description available.'}`}
                        isNew={true} 
                    />
                ))}
            </div>
        </section>

        {/* Individual Sections */}
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
            
            {/* Latest Posts */}
            <section>
                <h3 class="text-2xl font-bold mb-4">Latest Posts</h3>
                <div class="space-y-4">
                    {latestPosts.map(item => (
                        <ContentCard
                             title={item.title}
                             date={item.date}
                             url={item.url}
                             description={item.description}
                        />
                    ))}
                </div>
            </section>

            {/* Latest Games */}
            <section>
                <h3 class="text-2xl font-bold mb-4">Latest Games</h3>
                <div class="space-y-4">
                     {latestGames.map(item => (
                        <ContentCard
                             title={item.title}
                             date={item.date}
                             url={item.url}
                             description={item.description}
                        />
                    ))}
                </div>
            </section>

             {/* Latest Tools */}
             <section>
                <h3 class="text-2xl font-bold mb-4">Latest Tools</h3>
                <div class="space-y-4">
                     {latestTools.map(item => (
                        <ContentCard
                             title={item.title}
                             date={item.date}
                             url={item.url}
                             description={item.description}
                        />
                    ))}
                </div>
            </section>

             {/* Latest Stories */}
             <section>
                <h3 class="text-2xl font-bold mb-4">Latest Stories</h3>
                <div class="space-y-4">
                     {latestStories.map(item => (
                        <ContentCard
                             title={item.title}
                             date={item.date}
                             url={item.url}
                             description={item.description}
                        />
                    ))}
                </div>
            </section>

        </div>

    </div>
</BaseLayout>
