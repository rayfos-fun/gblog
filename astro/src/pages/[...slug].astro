---
import { getCollection, getEntry } from 'astro:content';
import PostList from '../components/pages/PostList.astro';
import GameList from '../components/pages/GameList.astro';
import ToolList from '../components/pages/ToolList.astro';
import StoryList from '../components/pages/StoryList.astro';
import TowerOfHanoi from '../components/games/TowerOfHanoi.astro';
import LightsOut from '../components/games/LightsOut.astro';
import PegSolitaire from '../components/games/PegSolitaire.astro';
import Memory from '../components/games/Memory.astro';
import Game2048 from '@/components/games/Game2048.astro';
import ColorsGame from '@/components/games/ColorsGame.astro'; // Assuming this might exist or just placeholder? 
// No, I should stick to existing pattern
import ThreeHeroes from '@/components/games/ThreeHeroes.astro';
import LightsOut from '../components/games/LightsOut.astro';
import GameLayout from '@/layouts/GameLayout.astro';
import PostLayout from '@/layouts/PostLayout.astro';
import LoopTimer from '@/components/tools/LoopTimer.astro';
import ReadingProgressRecorder from '@/components/ReadingProgressRecorder.astro';

// Type Definitions
type RouteType = 'home' | 'post-list' | 'game-list' | 'post' | 'game';

export async function getStaticPaths() {
  const languages = ['en', 'zh-tw', 'zh-cn'];
  const paths = [];

  const allPosts = await getCollection('posts');
  const allGames = await getCollection('games');
  const allTools = await getCollection('tools');
  const allStories = await getCollection('stories');

  for (const lang of languages) {
    const isEn = lang === 'en';
    const langPrefix = isEn ? '' : `${lang}/`;

    // 1. Language Home (Handled by [lang]/index.astro)
    // Removed logic here


    // 2. Post List
    paths.push({ 
        params: { slug: isEn ? 'posts' : `${lang}/posts` }, 
        props: { type: 'post-list', lang } 
    });

    // 3. Game List
    paths.push({ 
        params: { slug: isEn ? 'games' : `${lang}/games` }, 
        props: { type: 'game-list', lang } 
    });

    // 4. Tool List
    paths.push({
        params: { slug: isEn ? 'tools' : `${lang}/tools` },
        props: { type: 'tool-list', lang }
    });

    // 5. Individual Posts
    const postsInLang = allPosts.filter(p => p.id.startsWith(`${lang}/`));
    // Sort by date descending (Newest first)
    postsInLang.sort((a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf());

    for (let i = 0; i < postsInLang.length; i++) {
        const post = postsInLang[i];
        const cleanSlug = post.slug.split('/').slice(1).join('/'); // remove lang prefix
        
        // Next post (index - 1 because we are sorted desc) -> Newer post
        const nextPost = i > 0 ? postsInLang[i - 1] : null;
        // Prev post (index + 1) -> Older post
        const prevPost = i < postsInLang.length - 1 ? postsInLang[i + 1] : null;

        paths.push({
            params: { slug: isEn ? `post/${cleanSlug}` : `${lang}/post/${cleanSlug}` },
            props: { 
                type: 'post', 
                lang, 
                item: post,
                prevPost: prevPost ? { 
                    title: prevPost.data.title, 
                    url: isEn ? `/post/${prevPost.slug.split('/').slice(1).join('/')}` : `/${lang}/post/${prevPost.slug.split('/').slice(1).join('/')}`
                } : null,
                nextPost: nextPost ? { 
                    title: nextPost.data.title, 
                    url: isEn ? `/post/${nextPost.slug.split('/').slice(1).join('/')}` : `/${lang}/post/${nextPost.slug.split('/').slice(1).join('/')}`
                } : null
            }
        });
    }

    // 5. Individual Games
    const gamesInLang = allGames.filter(g => g.id.startsWith(`${lang}/`));
    for (const game of gamesInLang) {
        const cleanSlug = game.slug.split('/').slice(1).join('/');
        paths.push({
            params: { slug: isEn ? `game/${cleanSlug}` : `${lang}/game/${cleanSlug}` },
            props: { type: 'game', lang, item: game }
        });
    }

    // 6. Tools (Specific Request)
    const toolsInLang = allTools.filter(t => t.id.startsWith(`${lang}/`));
    for (const tool of toolsInLang) {
        const cleanSlug = tool.slug.split('/').slice(1).join('/');
        paths.push({
            // Request: /zh-tw/tool/loop-timer/
             params: { slug: isEn ? `tool/${cleanSlug}` : `${lang}/tool/${cleanSlug}` },
             props: { type: 'tool', lang, item: tool }
        });
    }

    // 7. Story List
    paths.push({
        params: { slug: isEn ? 'stories' : `${lang}/stories` },
        props: { type: 'story-list', lang }
    });

    // 8. Individual Stories
    const storiesInLang = allStories.filter(s => s.id.startsWith(`${lang}/`));
    // Sort Descending (Newest First) - similar to posts
    storiesInLang.sort((a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf());

    for (let i = 0; i < storiesInLang.length; i++) {
        const story = storiesInLang[i];
        const cleanSlug = story.slug.split('/').slice(1).join('/');

        // Logic matches Posts:
        // i - 1 is Newer (Next Chapter if released sequentially)
        // i + 1 is Older (Prev Chapter)
        
        // However, for Stories UI, users usually want:
        // Left Button: Previous Chapter (Older) -> similar to "Previous Post"
        // Right Button: Next Chapter (Newer) -> similar to "Next Post"

        const nextStory = i > 0 ? storiesInLang[i - 1] : null;
        const prevStory = i < storiesInLang.length - 1 ? storiesInLang[i + 1] : null;

        paths.push({
            params: { slug: isEn ? `story/${cleanSlug}` : `${lang}/story/${cleanSlug}` },
            props: { 
                type: 'story', 
                lang, 
                item: story,
                prevPost: prevStory ? {
                     title: prevStory.data.title,
                     url: isEn ? `/story/${prevStory.slug.split('/').slice(1).join('/')}` : `/${lang}/story/${prevStory.slug.split('/').slice(1).join('/')}`
                } : null,
                nextPost: nextStory ? {
                     title: nextStory.data.title,
                     url: isEn ? `/story/${nextStory.slug.split('/').slice(1).join('/')}` : `/${lang}/story/${nextStory.slug.split('/').slice(1).join('/')}`
                } : null
            }
        });
    }

    // 9. Static Pages (like Privacy Policy)
    const allPages = await getCollection('pages');
    const pagesInLang = allPages.filter(s => s.id.startsWith(`${lang}/`));
    for (const page of pagesInLang) {
        const cleanSlug = page.slug.split('/').slice(1).join('/');
        paths.push({
            params: { slug: isEn ? `${cleanSlug}` : `${lang}/${cleanSlug}` },
            props: { type: 'page', lang, item: page }
        });
    }
  }

  return paths;
}

const { type, lang, item } = Astro.props;
const { slug } = Astro.params;

// Helper to render post content
const { Content: PostContent } = (type === 'post' || type === 'tool' || type === 'story' || type === 'page') ? await item.render() : { Content: null };

// Helper to decide which game component to render
const getGameComponent = (gameSlug: string) => {
    // Check if it is Tower of Hanoi
    if (gameSlug && gameSlug.includes('tower-of-hanoi')) {
        return TowerOfHanoi;
    }
    if (gameSlug && gameSlug.includes('peg-solitaire')) return PegSolitaire;
    if (gameSlug && gameSlug.includes('memory')) return Memory;
    if (gameSlug && gameSlug.includes('lights-out')) return LightsOut;
    if (gameSlug && gameSlug.includes('2048')) return Game2048;
    if (gameSlug && gameSlug.includes('three-heroes')) return ThreeHeroes;
    return null;
}

// Helper for tools
const getToolComponent = (toolSlug: string) => {
    if (toolSlug && toolSlug.includes('loop-timer')) {
        return LoopTimer;
    }
    return null;
}

const GameComponent = type === 'game' ? getGameComponent(item.slug) : null;
const ToolComponent = type === 'tool' ? getToolComponent(item.slug) : null;
---



{type === 'post-list' && (
    <PostList lang={lang} />
)}

{type === 'game-list' && (
    <GameList lang={lang} />
)}

{type === 'tool-list' && (
    <ToolList lang={lang} />
)}

{type === 'story-list' && (
    <StoryList lang={lang} />
)}

{type === 'post' && (
    <PostLayout title={item.data.title} lang={lang} prevPost={Astro.props.prevPost} nextPost={Astro.props.nextPost}>
        <article class="prose lg:prose-xl mx-auto dark:prose-invert">
            <h1>{item.data.title}</h1>
            <PostContent />
        </article>
    </PostLayout>
)}

{type === 'story' && (
    <PostLayout 
        title={item.data.title} 
        lang={lang}
        prevPost={Astro.props.prevPost}
        nextPost={Astro.props.nextPost}
        prevText={{
            'en': 'Previous Chapter',
            'zh-tw': '上一回',
            'zh-cn': '上一回'
        }[lang] || 'Previous Chapter'}
        nextText={{
            'en': 'Next Chapter',
            'zh-tw': '下一回',
            'zh-cn': '下一回'
        }[lang] || 'Next Chapter'}
    >
        <ReadingProgressRecorder />
        <article class="prose lg:prose-xl mx-auto dark:prose-invert">
            <h1>{item.data.title}</h1>
            <PostContent />
        </article>
    </PostLayout>
)}

{type === 'page' && (
    <PostLayout title={item.data.title} lang={lang}>
        <article class="prose lg:prose-xl mx-auto dark:prose-invert mb-8">
            <h1>{item.data.title}</h1>
            <PostContent />
        </article>
    </PostLayout>
)}

{type === 'game' && GameComponent && (
    item.slug.includes('2048') ? (
        <GameLayout title={item.data.title} lang={lang} bgmSrc={item.data.bgmSrc}>
            <GameComponent game={item} lang={lang} />
        </GameLayout>
    ) : (
        <GameComponent game={item} lang={lang} />
    )
)}

{type === 'game' && !GameComponent && (
    <div class="p-10 text-center">
        <h1 class="text-2xl font-bold">Game Not Found (Component Missing)</h1>
    </div>
)}

{type === 'tool' && ToolComponent && (
    <PostLayout title={item.data.title} lang={lang}>
        <article class="prose lg:prose-xl mx-auto dark:prose-invert mb-8">
            <h1>{item.data.title}</h1>
            <PostContent />
        </article>
        <ToolComponent lang={lang} />
    </PostLayout>
)}
