---
import { getCollection, getEntry } from 'astro:content';
import PostList from '../components/pages/PostList.astro';
import GameList from '../components/pages/GameList.astro';
import ToolList from '../components/pages/ToolList.astro';
import TowerOfHanoi from '../components/games/TowerOfHanoi.astro';
import PostLayout from '@/layouts/PostLayout.astro';
import LoopTimer from '@/components/tools/LoopTimer.astro';

// Type Definitions
type RouteType = 'home' | 'post-list' | 'game-list' | 'post' | 'game';

export async function getStaticPaths() {
  const languages = ['en', 'zh-tw', 'zh-cn'];
  const paths = [];

  const allPosts = await getCollection('posts');
  const allGames = await getCollection('games');
  const allTools = await getCollection('tools');

  for (const lang of languages) {
    const isEn = lang === 'en';
    const langPrefix = isEn ? '' : `${lang}/`;

    // 1. Language Home
    // For English, slug is undefined (matches root /).
    // For others, slug is just the lang code.
    paths.push({ 
        params: { slug: isEn ? undefined : lang }, 
        props: { type: 'home', lang } 
    });

    // 2. Post List
    paths.push({ 
        params: { slug: isEn ? 'posts' : `${lang}/posts` }, 
        props: { type: 'post-list', lang } 
    });

    // 3. Game List
    paths.push({ 
        params: { slug: isEn ? 'games' : `${lang}/games` }, 
        props: { type: 'game-list', lang } 
    });

    // 4. Tool List
    paths.push({
        params: { slug: isEn ? 'tools' : `${lang}/tools` },
        props: { type: 'tool-list', lang }
    });

    // 5. Individual Posts
    const postsInLang = allPosts.filter(p => p.id.startsWith(`${lang}/`));
    for (const post of postsInLang) {
        const cleanSlug = post.slug.split('/').slice(1).join('/'); // remove lang prefix
        paths.push({
            params: { slug: isEn ? `post/${cleanSlug}` : `${lang}/post/${cleanSlug}` },
            props: { type: 'post', lang, item: post }
        });
    }

    // 5. Individual Games
    const gamesInLang = allGames.filter(g => g.id.startsWith(`${lang}/`));
    for (const game of gamesInLang) {
        const cleanSlug = game.slug.split('/').slice(1).join('/');
        paths.push({
            params: { slug: isEn ? `game/${cleanSlug}` : `${lang}/game/${cleanSlug}` },
            props: { type: 'game', lang, item: game }
        });
    }

    // 6. Tools (Specific Request)
    const toolsInLang = allTools.filter(t => t.id.startsWith(`${lang}/`));
    for (const tool of toolsInLang) {
        const cleanSlug = tool.slug.split('/').slice(1).join('/');
        paths.push({
            // Request: /zh-tw/tool/loop-timer/
             params: { slug: isEn ? `tool/${cleanSlug}` : `${lang}/tool/${cleanSlug}` },
             props: { type: 'tool', lang, item: tool }
        });
    }
  }

  return paths;
}

const { type, lang, item } = Astro.props;
const { slug } = Astro.params;

// Helper to render post content
const { Content: PostContent } = (type === 'post' || type === 'tool') ? await item.render() : { Content: null };

// Helper to decide which game component to render
const getGameComponent = (gameSlug: string) => {
    // Check if it is Tower of Hanoi
    if (gameSlug && gameSlug.includes('tower-of-hanoi')) {
        return TowerOfHanoi;
    }
    return null;
}

// Helper for tools
const getToolComponent = (toolSlug: string) => {
    if (toolSlug && toolSlug.includes('loop-timer')) {
        return LoopTimer;
    }
    return null;
}

const GameComponent = type === 'game' ? getGameComponent(item.slug) : null;
const ToolComponent = type === 'tool' ? getToolComponent(item.slug) : null;
---

{type === 'home' && (
    <meta http-equiv="refresh" content={`0;url=${lang === 'en' ? '/posts' : `/${lang}/posts`}`} />
)}

{type === 'post-list' && (
    <PostList lang={lang} />
)}

{type === 'game-list' && (
    <GameList lang={lang} />
)}

{type === 'tool-list' && (
    <ToolList lang={lang} />
)}

{type === 'post' && (
    <PostLayout title={item.data.title} lang={lang}>
        <article class="prose lg:prose-xl mx-auto dark:prose-invert">
            <h1>{item.data.title}</h1>
            <PostContent />
        </article>
    </PostLayout>
)}

{type === 'game' && GameComponent && (
    <GameComponent game={item} lang={lang} />
)}

{type === 'game' && !GameComponent && (
    <div class="p-10 text-center">
        <h1 class="text-2xl font-bold">Game Not Found (Component Missing)</h1>
    </div>
)}

{type === 'tool' && ToolComponent && (
    <PostLayout title={item.data.title} lang={lang}>
        <article class="prose lg:prose-xl mx-auto dark:prose-invert mb-8">
            <h1>{item.data.title}</h1>
            <PostContent />
        </article>
        <ToolComponent lang={lang} />
    </PostLayout>
)}
