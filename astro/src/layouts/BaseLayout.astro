---
interface Props {
  title: string;
  lang: string;
}

import Comments from '@/components/Comments.astro';

const { title, lang } = Astro.props;
const { pathname } = Astro.url;

const homeLink = lang === 'en' ? '/' : `/${lang}`;
const postLink = lang === 'en' ? '/posts' : `/${lang}/posts`;
const gameLink = lang === 'en' ? '/games' : `/${lang}/games`;
const toolLink = lang === 'en' ? '/tools' : `/${lang}/tools`;
const storyLink = lang === 'en' ? '/stories' : `/${lang}/stories`;

const languages = [
  { code: 'en', label: 'English' },
  { code: 'zh-tw', label: '繁體中文' },
  { code: 'zh-cn', label: '简体中文' },
];

const navI18n = {
  'en': { posts: 'Posts', games: 'Games', tools: 'Tools', stories: 'Stories', language: 'Language', login: 'Login', logout: 'Logout', privacyPolicy: 'Privacy Policy' },
  'zh-tw': { posts: '文章', games: '遊戲', tools: '工具', stories: '故事', language: '語言', login: '登入', logout: '登出', privacyPolicy: '隱私權政策' },
  'zh-cn': { posts: '文章', games: '游戏', tools: '工具', stories: '故事', language: '语言', login: '登录', logout: '登出', privacyPolicy: '隐私权政策' },
};

const tNav = navI18n[lang] || navI18n['en'];

const otherLanguages = languages.filter((l) => l.code !== lang);

function getLangLink(targetLang: string) {
  let cleanPath = pathname;
  
  // Explicitly strip language prefix if present
  // This handles both /en/ (explicit home) and /zh-tw/...
  const currentLangPrefix = `/${lang}`;
  if (pathname === currentLangPrefix || pathname === currentLangPrefix + '/') {
      cleanPath = '/';
  } else if (pathname.startsWith(currentLangPrefix + '/')) {
      cleanPath = pathname.slice(currentLangPrefix.length);
  }
  
  // Ensure consistent slash handling
  if (!cleanPath.startsWith('/')) cleanPath = '/' + cleanPath;
  
  // Clean path is now the agnostic route (e.g., '/' or '/posts' or '/game/...')

  if (targetLang === 'en') {
     // English Home should be explicit /en/
     if (cleanPath === '/') return '/en/';
     // Other English pages are at root
     return cleanPath;
  }
  
  // Other languages
  if (cleanPath === '/') return `/${targetLang}/`;
  return `/${targetLang}${cleanPath}`;
}
---

<!DOCTYPE html>
<html lang={lang} data-theme="cupcake">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{title} | Rayfos</title>
    <script is:inline>
      // Theme init
      const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'cupcake');
      document.documentElement.setAttribute('data-theme', theme);
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    </script>
  </head>
  <body class="min-h-screen flex flex-col">
    
    <div class="navbar bg-base-100 shadow-sm">
      <script define:vars={{ lang }}>
        try {
          localStorage.setItem('preferred-lang', lang);
        } catch (e) {
          console.error('Could not save language preference:', e);
        }
      </script>
      <div class="flex-1">
        <a href={homeLink} class="btn btn-ghost text-xl">Rayfos</a>
      </div>
      <div class="flex-none gap-2">
        <label class="swap swap-rotate btn btn-ghost btn-circle">
            <input type="checkbox" id="theme-controller" />
            
            {/* sun icon */}
            <svg class="swap-on fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/></svg>
            
            {/* moon icon */}
            <svg class="swap-off fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/></svg>
        </label>

        <ul class="menu menu-horizontal px-1">
          <li><a href={postLink}>{tNav.posts}</a></li>
          <li><a href={gameLink}>{tNav.games}</a></li>
          <li><a href={toolLink}>{tNav.tools}</a></li>
          <li><a href={storyLink}>{tNav.stories}</a></li>
          <li>
            <details>
              <summary>{tNav.language}</summary>
              <ul class="p-2 bg-base-100 rounded-t-none">
                {otherLanguages.map((l) => (
                  <li>
                    <a href={getLangLink(l.code)}>
                      {l.label}
                    </a>
                  </li>
                ))}
              </ul>
            </details>
          </li>
          {/* Login/User Section */}
          <li>
            <a id="login-btn" href="/login" class="hidden">{tNav.login}</a>
            <div id="user-info" class="hidden flex items-center gap-2">
                <img id="user-avatar" src="" alt="User Avatar" class="w-8 h-8 rounded-full" />
                <span id="user-name" class="max-w-[100px] truncate hidden md:inline font-bold"></span>
                <button id="edit-nickname-btn" class="btn btn-ghost btn-xs text-xs opacity-70 hover:opacity-100" title="Edit Nickname">
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
                <a href="/logout" class="text-xs opacity-70 hover:opacity-100 ml-1">({tNav.logout})</a>
            </div>
          </li>
        </ul>
      </div>
    </div>
    
    <script is:inline>
      // Auth Check
      fetch('/api/me')
        .then(res => res.json())
        .then(data => {
            const loginBtn = document.getElementById('login-btn');
            const userInfo = document.getElementById('user-info');
            
            if (data.authed) {
                if (userInfo) {
                    userInfo.classList.remove('hidden');
                    const avatar = document.getElementById('user-avatar');
                    if (avatar) avatar.src = data.picture;
                    const name = document.getElementById('user-name');
                    if (name) name.textContent = data.nickname || data.name || 'Anonymous';
                    
                    // Edit Nickname Logic
                    const editBtn = document.getElementById('edit-nickname-btn');
                    if (editBtn) {
                        editBtn.onclick = () => {
                            const currentName = name.textContent;
                            const newName = prompt('Enter new nickname (1-20 chars):', currentName);
                            if (newName && newName.trim() !== '' && newName !== currentName) {
                                fetch('/api/user/nickname', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ nickname: newName })
                                })
                                .then(res => res.json())
                                .then(resData => {
                                    if (resData.status === 'success') {
                                        name.textContent = resData.nickname;
                                    } else {
                                        alert(resData.error || 'Failed to update nickname');
                                    }
                                })
                                .catch(err => {
                                    console.error(err);
                                    alert('Error updating nickname');
                                });
                            }
                        };
                    }
                }
            } else {
                if (loginBtn) loginBtn.classList.remove('hidden');
            }
        })
        .catch(err => console.log('Auth check failed', err));
    </script>

    <main class="flex-grow container mx-auto px-4 py-8">
      <slot />
      <Comments lang={lang as any} />
    </main>

    <footer class="footer footer-center p-10 bg-base-200 text-base-content rounded">
      <nav class="grid grid-flow-col gap-4">
        <a href="#" class="link link-hover">About us</a>
        <a href="#" class="link link-hover">Contact</a>
        <a href={lang === 'en' ? '/privacy-policy' : `/${lang}/privacy-policy`} class="link link-hover">{tNav.privacyPolicy}</a>
      </nav> 
      <nav>
        <div class="grid grid-flow-col gap-4">
          <a href="https://github.com/rayfos-fun/gblog" aria-label="Github">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="fill-current"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
          </a>
        </div>
      </nav> 
    </footer>

    <script is:inline>
      // Theme Controller Logic
      const themeController = document.getElementById('theme-controller');
      if (themeController) {
        // Sync state with current theme
        const currentTheme = document.documentElement.getAttribute('data-theme');
        themeController.checked = currentTheme === 'dark';

        themeController.addEventListener('change', (e) => {
           const newTheme = e.target.checked ? 'dark' : 'cupcake';
           document.documentElement.setAttribute('data-theme', newTheme);
           if (newTheme === 'dark') {
             document.documentElement.classList.add('dark');
           } else {
             document.documentElement.classList.remove('dark');
           }
           localStorage.setItem('theme', newTheme);
        });
      }
    </script>
  </body>
</html>