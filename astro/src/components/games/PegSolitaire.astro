---
import GameLayout from '@/layouts/GameLayout.astro';

interface Props {
  game: any;
  lang: string;
}

const { game, lang } = Astro.props;
const { i18n } = game.data;
---

<GameLayout title={game.data.title} lang={lang as any} bgmSrc={game.data.bgmSrc}>
    <div class="game-wrapper flex flex-col items-center gap-6 p-8 rounded-3xl bg-slate-50 dark:bg-slate-900 shadow-2xl border-4 border-slate-200 dark:border-slate-700 max-w-4xl mx-auto my-8" data-i18n={JSON.stringify(i18n)}>
        <!-- Stats Dashboard -->
        <div class="grid grid-cols-2 gap-4 w-full max-w-lg mb-6">
            <div class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center gap-4">
                <div class="bg-blue-100 dark:bg-blue-900/30 p-3 rounded-xl">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                </div>
                <div>
                    <div class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">{i18n.labels.pegs}</div>
                    <div id="peg-count" class="text-2xl font-mono font-bold text-slate-800 dark:text-slate-100">32</div>
                </div>
            </div>
            
            <div id="game-status" class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center justify-center font-bold text-lg text-slate-500">
                {i18n.status.playing}
            </div>
        </div>

        <!-- Game Board -->
        <div class="bg-[#deb887] p-4 rounded-xl shadow-[inset_0_2px_10px_rgba(0,0,0,0.3)] border-4 border-[#8B4513]">
            <div id="board" class="grid grid-cols-7 gap-1.5 md:gap-2">
                <!-- Grid items generated by JS -->
            </div>
        </div>

        <!-- Controls -->
        <div class="controls flex gap-4 mt-4">
            <button 
                id="restart-btn" 
                class="px-8 py-3 rounded-full bg-blue-500 hover:bg-blue-600 text-white font-bold shadow-lg transition-colors"
            >
                {i18n.controls.restart}
            </button>
        </div>
        
        <div id="message-area" class="h-8 text-xl font-bold text-center text-primary min-h-[2rem]"></div>
    </div>

    <script>
        import { PegSolitaireEngine } from '../../lib/PegSolitaireEngine';

        // DOM Elements
        const wrapper = document.querySelector('.game-wrapper');
        const boardEl = document.getElementById('board');
        const pegCountEl = document.getElementById('peg-count');
        const statusEl = document.getElementById('game-status');
        const messageEl = document.getElementById('message-area');
        const restartBtn = document.getElementById('restart-btn');

        // I18n
        const i18n = JSON.parse(wrapper.dataset.i18n || '{}');
        const messages = i18n.messages;

        // Game State
        const game = new PegSolitaireEngine();
        let selected = null; // {r, c}

        function initGame() {
            game.init();
            selected = null;
            render();
            updateStats();
            messageEl.textContent = '';
            statusEl.textContent = i18n.status.playing;
            statusEl.className = 'bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center justify-center font-bold text-lg text-slate-500';
            messageEl.textContent = messages.start || 'Select a peg to start';
        }

        function handleCellClick(r, c) {
            if (game.status !== 'PLAYING') return;

            const cellState = game.getCell(r, c);

            // 1. Select Peg
            if (cellState === 'PEG') {
                selected = { r, c };
                render(); // Update selection UI
                messageEl.textContent = (messages.select || 'Selected peg ') + `(${r},${c})`;
            }
            // 2. Move to Hole
            else if (cellState === 'HOLE' && selected) {
                const result = game.attemptMove(selected, { r, c });
                
                if (result === 'SUCCESS') {
                    selected = null;
                    render();
                    updateStats();
                    messageEl.textContent = '';
                } else if (result === 'INVALID') {
                    messageEl.textContent = messages.warn || 'Invalid Move!';
                } else if (result === 'GAME_OVER_WIN') {
                    selected = null;
                    render();
                    updateStats();
                    messageEl.textContent = messages.win || 'You Won!';
                    statusEl.textContent = i18n.status.victory;
                    statusEl.classList.add('text-green-500');
                } else if (result === 'GAME_OVER_LOSS') {
                    selected = null;
                    render();
                    updateStats();
                    messageEl.textContent = messages.empty || 'Game Over!'; 
                    statusEl.textContent = i18n.status.defeat;
                    statusEl.classList.add('text-red-500');
                }
            } else if (cellState === 'HOLE' && !selected) {
                 messageEl.textContent = messages.empty || 'No peg here';
            }
        }

        function render() {
            boardEl.innerHTML = '';
            
            for (let r = 0; r < 7; r++) {
                for (let c = 0; c < 7; c++) {
                    const cellState = game.getCell(r, c);
                    const cellDiv = document.createElement('div');
                    
                    // Base styles for all cells
                    cellDiv.className = 'w-10 h-10 md:w-12 md:h-12 rounded-full flex items-center justify-center transition-all duration-200';

                    if (cellState === 'INVALID') {
                        cellDiv.classList.add('invisible'); // Hide invalid corners
                    } else {
                        cellDiv.classList.add('cursor-pointer');
                        
                        // Hole style
                        cellDiv.classList.add('bg-[#5c4033]', 'shadow-[inset_1px_1px_3px_rgba(0,0,0,0.5)]');

                        if (cellState === 'PEG') {
                            const pegDiv = document.createElement('div');
                            pegDiv.className = 'w-8 h-8 md:w-10 md:h-10 rounded-full bg-gradient-to-br from-red-400 to-red-600 shadow-md pointer-events-none transform transition-transform';
                            
                            // Selection Highlight
                            if (selected && selected.r === r && selected.c === c) {
                                pegDiv.classList.add('scale-110', 'ring-4', 'ring-yellow-400', 'from-teal-400', 'to-teal-600');
                            }
                            
                            cellDiv.appendChild(pegDiv);
                        }

                        // Interaction
                        cellDiv.onclick = () => handleCellClick(r, c);
                    }

                    boardEl.appendChild(cellDiv);
                }
            }
        }

        function updateStats() {
            pegCountEl.textContent = game.pegsRemaining;
            if (game.status === 'PLAYING') {
                statusEl.textContent = 'Playing';
                statusEl.className = 'bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center justify-center font-bold text-lg text-slate-500';
            }
        }

        restartBtn.onclick = initGame;

        // Start
        initGame();
    </script>
</GameLayout>
