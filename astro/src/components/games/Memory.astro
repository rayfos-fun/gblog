---
import GameLayout from '@/layouts/GameLayout.astro';

interface Props {
  game: any;
  lang: string;
}

const { game, lang } = Astro.props;
const { i18n } = game.data;
---

<GameLayout title={game.data.title} lang={lang as any} bgmSrc={game.data.bgmSrc}>
    <div class="game-wrapper flex flex-col items-center gap-8 p-8 max-w-4xl mx-auto my-8" data-i18n={JSON.stringify(i18n)}>
        <!-- Stats Dashboard -->
        <div class="grid grid-cols-2 gap-4 w-full max-w-md">
            <div class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col items-center">
                <div class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">{i18n.labels.score}</div>
                <div id="score-val" class="text-3xl font-mono font-bold text-slate-800 dark:text-slate-100">0</div>
            </div>
            <div class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col items-center">
                <div class="text-xs font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400">{i18n.labels.highScore}</div>
                <div id="high-score-val" class="text-3xl font-mono font-bold text-amber-500">0</div>
            </div>
        </div>

        <div id="status-text" class="text-xl font-bold h-8 text-slate-600 dark:text-slate-300 min-h-[2rem]">
            {i18n.messages.start}
        </div>

        <!-- Simon Board -->
        <!-- Container for the circle -->
        <div class="relative w-72 h-72 md:w-96 md:h-96 rounded-full bg-slate-800 p-2 shadow-2xl ring-4 ring-slate-300 dark:ring-slate-700">
            <div class="grid grid-cols-2 grid-rows-2 gap-2 w-full h-full rounded-full overflow-hidden">
                <!-- Green (0) -->
                <button id="btn-0" class="simon-btn bg-green-500 hover:bg-green-400 active:bg-green-300 transition-all duration-100 border-none outline-none focus:outline-none" aria-label="Green"></button>
                <!-- Red (1) -->
                <button id="btn-1" class="simon-btn bg-red-500 hover:bg-red-400 active:bg-red-300 transition-all duration-100 border-none outline-none focus:outline-none" aria-label="Red"></button>
                <!-- Yellow (2) -->
                <button id="btn-2" class="simon-btn bg-yellow-500 hover:bg-yellow-400 active:bg-yellow-300 transition-all duration-100 border-none outline-none focus:outline-none" aria-label="Yellow"></button>
                <!-- Blue (3) -->
                <button id="btn-3" class="simon-btn bg-blue-500 hover:bg-blue-400 active:bg-blue-300 transition-all duration-100 border-none outline-none focus:outline-none" aria-label="Blue"></button>
            </div>
            
            <!-- Center Start Button Overlay -->
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-1/3 h-1/3 bg-white dark:bg-slate-900 rounded-full flex items-center justify-center border-4 border-slate-800 z-10 shadow-lg">
                <button id="start-btn" class="text-lg md:text-xl font-black text-slate-800 dark:text-white uppercase tracking-widest hover:scale-105 transition-transform">
                    {i18n.controls.start}
                </button>
            </div>
        </div>
    </div>

    <script>
        import { MemoryEngine } from '../../lib/MemoryEngine';

        // DOM Elements
        const wrapper = document.querySelector('.game-wrapper');
        const scoreVal = document.getElementById('score-val');
        const highScoreVal = document.getElementById('high-score-val');
        const statusText = document.getElementById('status-text');
        const startBtn = document.getElementById('start-btn');
        const gameButtons = [
            document.getElementById('btn-0'),
            document.getElementById('btn-1'),
            document.getElementById('btn-2'),
            document.getElementById('btn-3')
        ];

        // I18n
        const i18n = JSON.parse(wrapper.dataset.i18n || '{}');
        const messages = i18n.messages;

        // Audio Context
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const frequencies = [261.63, 293.66, 329.63, 349.23]; // C4, D4, E4, F4
        
        // Game State
        const STORAGE_KEY = 'memory_game_high_score';
        const storedHighScore = parseInt(localStorage.getItem(STORAGE_KEY) || '0', 10);
        const engine = new MemoryEngine(storedHighScore);
        
        let isProcessingSequence = false;

        // --- Audio Functions ---
        function playTone(index) {
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            osc.type = 'sine';
            osc.frequency.value = frequencies[index];
            
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);

            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        function playErrorTone() {
             if (audioCtx.state === 'suspended') audioCtx.resume();
             const osc = audioCtx.createOscillator();
             const gainNode = audioCtx.createGain();
             osc.type = 'sawtooth';
             osc.frequency.value = 150; 
             osc.connect(gainNode);
             gainNode.connect(audioCtx.destination);
             gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
             gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.8);
             osc.start();
             osc.stop(audioCtx.currentTime + 0.8);
        }

        // --- UI Functions ---
        function highlightButton(index) {
            const btn = gameButtons[index];
            btn.classList.add('brightness-150', 'scale-95'); // Tailwind utility brightness for "flash"
            // If brightness doesn't work well on colored bg, try opacity or fallback
            // Adding a class that enforces a lighter color might be safer
            // or just use the active style manually
            btn.classList.add('active-flash');
            playTone(index);
            setTimeout(() => {
                btn.classList.remove('brightness-150', 'scale-95', 'active-flash');
            }, 300);
        }

        async function playSequence() {
            isProcessingSequence = true;
            statusText.textContent = messages.watch || 'Watch closely...';
            startBtn.disabled = true;
            
            // Wait a bit before starting
            await new Promise(r => setTimeout(r, 600));

            const sequence = engine.currentState.sequence;
            for (const colorIndex of sequence) {
                highlightButton(colorIndex);
                await new Promise(r => setTimeout(r, 600)); // 300ms flash + 300ms gap
            }

            statusText.textContent = messages.play || 'Your turn!';
            isProcessingSequence = false;
            engine.enableInput();
        }

        function updateStats() {
            const state = engine.currentState;
            scoreVal.textContent = state.score;
            highScoreVal.textContent = state.highScore;
            localStorage.setItem(STORAGE_KEY, state.highScore.toString());
        }

        function handleInput(index) {
            if (isProcessingSequence || engine.currentState.status !== 'PLAYING') return;

            // Visual feedback immediately
            highlightButton(index);

            const result = engine.handleInput(index);

            if (result === 'CORRECT') {
                // Good, continue
            } else if (result === 'ROUND_COMPLETE') {
                updateStats();
                statusText.textContent = messages.good || 'Great job!';
                engine.nextRound(); // Generate next
                setTimeout(playSequence, 500);
            } else if (result === 'WRONG') {
                playErrorTone();
                statusText.textContent = messages.gameover || 'Game Over!';
                startBtn.textContent = i18n.controls.restart || 'Restart';
                startBtn.disabled = false;
                startBtn.classList.remove('opacity-50');
                updateStats(); // Save high score
            }
        }

        // --- Initialization ---
        highScoreVal.textContent = storedHighScore;

        startBtn.onclick = () => {
            engine.startGame();
            updateStats();
            startBtn.textContent = '...'; 
            startBtn.disabled = true;
            // Maybe hide start button or make it status?
            // Center is "Start" initially. When playing, it can be "Score" or just decorative logo.
            // Let's keep it as text display? Or just disable it.
            playSequence();
        };

        gameButtons.forEach((btn, idx) => {
            btn.onclick = () => handleInput(idx);
        });

        // Add CSS for active flash manually if tailwind filter not enough
        const style = document.createElement('style');
        style.textContent = `
            .active-flash {
                filter: brightness(1.7);
                box-shadow: 0 0 20px currentColor;
            }
        `;
        document.head.appendChild(style);

    </script>
</GameLayout>
