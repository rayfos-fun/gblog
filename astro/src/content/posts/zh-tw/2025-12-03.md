---
title: "[技術慘案] 一個外部呼叫引發的系統雪崩：差點毀了我們團隊的感恩節"
date: "2025-12-03"
---
最近組上的軟體效能慢到令人髮指，錯誤回報單（Bug Ticket）如雪片般飛來，每一張單子都像是一記重拳，砸得組上每個人灰頭土臉。眼看感恩節假期就要到了，大家卻連放心的本錢都沒有。

為了不想在假期中被緊急電話叫醒，我們開始了地毯式的排查。

### 詭異的資料庫交易中斷

檢查系統日誌（Log）後，我們觀察到大量的「資料庫交易中斷」（Database Transaction Abort）。這是很典型的資源競爭現象，但源頭在哪？

經過抽絲剝繭，我們終於抓到了真兇：**資料庫交易過程中，參雜了耗時且不穩定的「遠端呼叫」（RPC）。**

這些外部呼叫導致資料庫交易的持有時間被非預期地拉長，進而佔用資料庫連線與鎖（Lock），最終造成資源死結（Deadlock）或超時。當我們果斷把這些遠端呼叫移出交易範圍後，系統瞬間恢復了平靜。

### 查了個寂寞：程式碼裡的「破窗效應」

最諷刺的是，一開始我們都在查「最近提交的程式碼」，結果查了個寂寞。

那些導致問題的遠端呼叫，根本不是最近加的，而是已經存在許久的「祖傳代碼」。那為什麼以前沒事，現在卻炸了？

1.  **量變產生質變**：隨著用戶有機成長，流量上來了。
2.  **外部依賴的不確定性**：遠端服務的回應時間並非我們可控。

以前外部服務回應快，加上用戶量還沒觸頂，就算偶爾發生交易中斷，系統的「自動重試機制」（Retry）也能掩蓋過去，開發者完全觀察不到異常。

這就形成了一種恐怖的 **「破窗效應」**：
後來的開發者看到程式碼庫（Code base）裡，前人把遠端呼叫寫在資料庫交易裡跑得好好的，自然不會多想，圖個方便也就跟著加。就這樣，從一片不起眼的雪花，滾成了一顆巨大的雪球，最後在流量高峰時引發了毀滅性的雪崩。

### 不經一事，不長一智

這次的教訓雖然慘痛，但也給了我們深刻的警示。

雖然理論上，在交易過程裡呼叫保證耗時短、無狀態（Stateless）的外部服務似乎無傷大雅，但「外部服務」永遠是最大的不穩定因素。

日後若想在資料庫交易裡加遠端呼叫，心裡必須得三思而後行：**你以為你只是加了一行程式碼，其實你可能是埋下了一顆不定時炸彈。**

為了系統的穩定，也為了自己能過個好節，請讓資料庫交易保持純粹。