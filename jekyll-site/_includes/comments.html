<div class="comments-section">
    <h3>{% if page.lang == 'zh-tw' %}留言{% elsif page.lang == 'zh-cn' %}评论{% else %}Comments{% endif %}</h3>
    <div id="comments-list">Thinking...</div>

    <div id="comment-form-container" style="display:none; margin-top: 20px;">
        <textarea id="comment-content" rows="4" maxlength="1000"
            style="width: 100%; border: 1px solid #ddd; padding: 10px; border-radius: 4px;"
            placeholder="{% if page.lang == 'zh-tw' %}寫下您的留言... (最多 1000 字節){% elsif page.lang == 'zh-cn' %}写下您的留言... (最多 1000 字节){% else %}Write a comment... (max 1000 bytes){% endif %}"></textarea>
        <div style="margin-top: 10px; text-align: right;">
            <button id="submit-comment"
                style="background-color: #333; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                {% if page.lang == 'zh-tw' %}發布留言{% elsif page.lang == 'zh-cn' %}发布评论{% else %}Post Comment{% endif %}
            </button>
        </div>
    </div>

    <div id="login-container" style="display:none; margin-top: 20px;">
        <p>
            {% if page.lang == 'zh-tw' %}
            請 <a href="/login?next={{ page.url | relative_url }}">登入</a> 以發表留言。
            {% elsif page.lang == 'zh-cn' %}
            请 <a href="/login?next={{ page.url | relative_url }}">登录</a> 以发表评论。
            {% else %}
            Please <a href="/login?next={{ page.url | relative_url }}">login</a> to leave a comment.
            {% endif %}
        </p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const slug = window.location.pathname;
        const commentsList = document.getElementById('comments-list');
        const formContainer = document.getElementById('comment-form-container');
        const loginContainer = document.getElementById('login-container');
        const contentInput = document.getElementById('comment-content');
        const submitBtn = document.getElementById('submit-comment');

        const uiText = {
            loading: "{% if page.lang == 'zh-tw' %}載入留言中...{% elsif page.lang == 'zh-cn' %}加载评论中...{% else %}Loading comments...{% endif %}",
            noComments: "{% if page.lang == 'zh-tw' %}尚無留言，成為第一個留言的人吧！{% elsif page.lang == 'zh-cn' %}暂无评论，成为第一个评论的人吧！{% else %}No comments yet. Be the first!{% endif %}",
            anonymous: "{% if page.lang == 'zh-tw' %}無名{% elsif page.lang == 'zh-cn' %}无名{% else %}Anonymous{% endif %}",
            toolLong: "{% if page.lang == 'zh-tw' %}留言過長 (最多 1000 字節)。{% elsif page.lang == 'zh-cn' %}评论过长 (最多 1000 字节)。{% else %}Comment is too long (max 1000 bytes).{% endif %}",
            posting: "{% if page.lang == 'zh-tw' %}發布中...{% elsif page.lang == 'zh-cn' %}发布中...{% else %}Posting...{% endif %}",
            postBtn: "{% if page.lang == 'zh-tw' %}發布留言{% elsif page.lang == 'zh-cn' %}发布评论{% else %}Post Comment{% endif %}",
            postErrorPrefix: "{% if page.lang == 'zh-tw' %}發布留言錯誤：{% elsif page.lang == 'zh-cn' %}发布评论错误：{% else %}Error posting comment: {% endif %}",
            postErrorGeneric: "{% if page.lang == 'zh-tw' %}發布留言失敗。{% elsif page.lang == 'zh-cn' %}发布评论失败。{% else %}Error posting comment.{% endif %}",
            loadError: "{% if page.lang == 'zh-tw' %}載入留言失敗。{% elsif page.lang == 'zh-cn' %}加载评论失败。{% else %}Error loading comments.{% endif %}",
            unknownError: "{% if page.lang == 'zh-tw' %}未知錯誤{% elsif page.lang == 'zh-cn' %}未知错误{% else %}Unknown error{% endif %}"
        };

        // Helper to update UI based on auth state
        function updateAuthUI(authed) {
            if (authed) {
                formContainer.style.display = 'block';
                loginContainer.style.display = 'none';
            } else {
                formContainer.style.display = 'none';
                loginContainer.style.display = 'block';
            }
        }

        // Fetch User Status
        fetch('/api/me')
            .then(response => response.json())
            .then(user => {
                updateAuthUI(user.authed);
            })
            .catch(err => console.error('Error checking auth:', err));

        // Listen for login success message from popup
        window.addEventListener("message", function (event) {
            if (event.data.type === 'LOGIN_SUCCESS') {
                updateAuthUI(true);
            }
        });

        // Fetch Comments
        function loadComments() {
            commentsList.innerHTML = uiText.loading;
            fetch(`/api/comments?slug=${encodeURIComponent(slug)}`)
                .then(response => response.json())
                .then(comments => {
                    if (comments.length === 0) {
                        commentsList.innerHTML = `<p>${uiText.noComments}</p>`;
                        return;
                    }

                    // Helper function to create a safe text element
                    function createCommentElement(comment) {
                        const div = document.createElement('div');
                        div.style.borderBottom = '1px solid #eee';
                        div.style.padding = '10px 0';

                        // Use textContent to automatically handle all dangerous characters
                        const author = document.createElement('div');
                        author.style.fontWeight = 'bold';
                        author.style.marginBottom = '4px';

                        let authorName = comment.author_name || 'Anonymous';
                        if (authorName === 'Anonymous') {
                            authorName = uiText.anonymous;
                        }

                        author.textContent = `${authorName} `;

                        const dateSpan = document.createElement('span');
                        dateSpan.style.fontWeight = 'normal';
                        dateSpan.style.color = '#888';
                        dateSpan.style.fontSize = '0.9em';
                        dateSpan.textContent = `- ${new Date(comment.created_at).toLocaleString()}`;

                        author.appendChild(dateSpan);

                        const body = document.createElement('div');
                        body.style.whiteSpace = 'pre-wrap';
                        body.textContent = comment.content;

                        div.appendChild(author);
                        div.appendChild(body);
                        return div;
                    }

                    commentsList.innerHTML = '';
                    comments.forEach(c => {
                        commentsList.appendChild(createCommentElement(c));
                    });
                })
                .catch(err => {
                    console.error('Error loading comments:', err);
                    commentsList.innerHTML = `<p>${uiText.loadError}</p>`;
                });
        }

        // Submit Comment
        submitBtn.addEventListener('click', function () {
            const content = contentInput.value.trim();
            if (!content) return;

            // Simple byte length check (approximate for UTF-8)
            const encoder = new TextEncoder();
            if (encoder.encode(content).length > 1000) {
                alert(uiText.toolLong);
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerText = uiText.posting;

            fetch('/api/comments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    slug: slug,
                    content: content
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        contentInput.value = '';
                        loadComments(); // Refresh list
                    } else {
                        alert(uiText.postErrorPrefix + (data.error || uiText.unknownError));
                    }
                })
                .catch(err => {
                    console.error('Error posting comment:', err);
                    alert(uiText.postErrorGeneric);
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerText = uiText.postBtn;
                });
        });



        loadComments();
    });
</script>