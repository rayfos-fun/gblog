{%- comment -%}
copied from .rbenv/versions/3.4.5/lib/ruby/gems/3.4.0/gems/minima-2.5.2/_includes/header.html
updated:
sort the default_paths by order
filter with lang
lang switch
added auth-container
{%- endcomment -%}
<header class="site-header" role="banner">

  <style>
    #auth-container {
      display: flex;
      align-items: center;
      float: right;
      margin-left: 20px;
      margin-top: 12px;
    }

    .btn-login-google {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background-color: #fff;
      color: #3c4043;
      border: 1px solid #dadce0;
      border-radius: 24px;
      padding: 6px 16px 6px 12px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s, box-shadow 0.2s;
      text-decoration: none !important;
      line-height: 1.2;
    }

    .btn-login-google:hover {
      background-color: #f7f8f8;
      box-shadow: 0 1px 3px rgba(60, 64, 67, 0.3);
      color: #202124;
    }

    .user-profile-pill {
      display: flex;
      align-items: center;
      background: #f1f3f4;
      border: 1px solid transparent;
      border-radius: 30px;
      padding: 4px 12px 4px 4px;
      transition: all 0.2s;
    }

    .user-profile-pill:hover {
      background: #e8eaed;
    }

    .user-avatar-img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 8px;
      object-fit: cover;
    }

    .user-name-text {
      font-size: 14px;
      font-weight: 600;
      color: #5f6368;
      margin-right: 8px;
      max-width: 100px;
      /* long name => ... */
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .btn-logout-link,
    .btn-edit-nickname {
      font-size: 12px;
      color: #1a73e8;
      text-decoration: none;
      padding-left: 8px;
      border-left: 1px solid #dadce0;
      cursor: pointer;
      margin-left: 8px;
    }

    .btn-logout-link:hover,
    .btn-edit-nickname:hover {
      text-decoration: underline;
    }
  </style>

  <div class="wrapper">
    {%- assign default_paths = site.pages | sort: 'order' | map: "path" -%}
    {%- assign page_paths = site.header_pages | default: default_paths -%}
    <a class="site-title" rel="author" href="{{ " /" | relative_url }}">{{ site.title | escape }}</a>

    <div id="auth-container">
    </div>

    {%- if page_paths -%}
    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path
              d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
          </svg>
        </span>
      </label>

      <div class="trigger">
        {%- for page_path in page_paths -%}
        {%- assign my_page = site.pages | where: "path", page_path | first -%}
        {%- if my_page.title and my_page.lang == page.lang and my_page.layout != 'itch' -%}
        <a class="page-link" href="{{ my_page.url | relative_url }}">{{ my_page.title | escape }}</a>
        {%- endif -%}
        {%- endfor -%}
      </div>
    </nav>
    <nav class="lang-switcher">
      {% if page.lang == 'en' %}
      <a onclick="toZhcn()">简</a>
      <a onclick="toZhtw()">繁</a>
      {% else %}
      <a onclick="toEn()">En</a>
      {% endif %}
    </nav>
    {%- endif -%}

  </div>

  <script>
    {% if page.lang == 'en' %}
    function toZhcn() {
      window.location.href = window.location.href.replace('en', 'zh-cn');
    }
    function toZhtw() {
      window.location.href = window.location.href.replace('en', 'zh-tw');
    }
    {% elsif page.lang == 'zh-cn' %}
    function toEn() {
      window.location.href = window.location.href.replace('zh-cn', 'en');
    }
    {% elsif page.lang == 'zh-tw' %}
    function toEn() {
      window.location.href = window.location.href.replace('zh-tw', 'en');
    }
    {% endif %}
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      }
    };

    (function () {
      const container = document.getElementById('auth-container');

      const uiText = {
        signIn: "{% if page.lang == 'zh-tw' %}登入{% elsif page.lang == 'zh-cn' %}登录{% else %}Sign in{% endif %}",
        logout: "{% if page.lang == 'zh-tw' %}登出{% elsif page.lang == 'zh-cn' %}登出{% else %}Logout{% endif %}",
        editNickname: "{% if page.lang == 'zh-tw' %}改名{% elsif page.lang == 'zh-cn' %}改名{% else %}Edit Name{% endif %}",
        promptNickname: "{% if page.lang == 'zh-tw' %}請輸入新的顯示名稱 (1-20字):{% elsif page.lang == 'zh-cn' %}请输入新的显示名称 (1-20字):{% else %}Enter new nickname (1-20 chars):{% endif %}",
        anonymous: "{% if page.lang == 'zh-tw' %}無名{% elsif page.lang == 'zh-cn' %}无名{% else %}Anonymous{% endif %}"
      };

      function renderAuthUI(user) {
        if (user && user.authed) {
          let displayName = user.nickname || user.name;
          if (displayName === 'Anonymous') {
            displayName = uiText.anonymous;
          }

          container.innerHTML = `
        <div class="user-profile-pill">
          <img src="${user.picture}" class="user-avatar-img" alt="User">
          <span class="user-name-text" title="${user.name}">${displayName}</span>
          <a onclick="editNickname()" class="btn-edit-nickname">${uiText.editNickname}</a>
          <a href="/logout" class="btn-logout-link">${uiText.logout}</a>
        </div>
      `;
        } else {
          container.innerHTML = `
        <button onclick="startGoogleLogin()" class="btn-login-google" type="button">
          <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" viewBox="0 0 48 48">
            <g>
              <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
              <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
              <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
              <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
            </g>
          </svg>
          ${uiText.signIn}
        </button>
      `;
        }
      }

      function checkStatus() {
        fetch('/api/me')
          .then(r => {
            if (!r.ok) throw new Error("API not found");
            return r.json();
          })
          .then(user => renderAuthUI(user))
          .catch(e => {
            console.warn("Auth check failed (likely locally or not logged in):", e);
            renderAuthUI({ authed: false });
          });
      }

      window.startGoogleLogin = function () {
        const isMobileOS = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        if (isMobileOS) {
          window.location.href = '/login?next=' + encodeURIComponent(window.location.pathname);
        } else {
          const w = 500, h = 600;
          const left = (screen.width - w) / 2;
          const top = (screen.height - h) / 2;
          window.open('/login?mode=popup', 'rayfos_auth', `width=${w},height=${h},top=${top},left=${left},scrollbars=yes`);
        }
      };

      window.editNickname = function () {
        const newNickname = prompt(uiText.promptNickname);
        if (newNickname !== null) {
          const trimmed = newNickname.trim();
          if (trimmed.length < 1 || trimmed.length > 20) {
            alert('Length must be between 1 and 20 characters.');
            return;
          }

          fetch('/api/user/nickname', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nickname: trimmed })
          })
            .then(r => r.json())
            .then(data => {
              if (data.status === 'success') {
                // Reload or update UI
                checkStatus(); // Re-fetch user info to update UI
              } else {
                alert('Error: ' + (data.error || 'Failed to update'));
              }
            })
            .catch(err => {
              console.error(err);
              alert('Network error');
            });
        }
      };

      window.addEventListener("message", function (event) {
        if (event.data.type === 'LOGIN_SUCCESS') {
          const user = event.data.user;
          user.authed = true;
          if (event.data.nickname) {
            user.nickname = event.data.nickname;
          }
          renderAuthUI(user);
        }
      });

      checkStatus();
    })();
  </script>
</header>