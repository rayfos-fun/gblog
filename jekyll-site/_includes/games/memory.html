{% assign locale = site.data.locales[page.lang] %}
{% assign game = locale.games.memory %}

{% assign game_title = game.title %}
{% assign btn_start = locale.start_game %}
{% assign btn_restart = locale.restart %}
{% assign score_label = game.score_label %}
{% assign high_score_label = game.high_score_label %}
{% assign status_start = game.status_start %}
{% assign status_watch = game.status_watch %}
{% assign status_play = game.status_play %}
{% assign status_gameover = locale.game_over_exc %}
{% assign status_newrecord = game.status_newrecord %}
{% assign sound_on = game.sound_on %}
{% assign sound_off = game.sound_off %}

<style>
  /* Game Container Styling */
  .game-container {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-width: 500px;
    margin: 0 auto;
    text-align: center;
    background-color: #2c3e50;
    padding: 20px;
    border-radius: 10px;
    color: white;
    user-select: none;
    box-sizing: border-box;
  }

  .game-header h2 {
    margin-top: 0;
    margin-bottom: 10px;
  }

  .game-status {
    font-size: 1.2em;
    margin-bottom: 15px;
    min-height: 1.5em;
    font-weight: bold;
    color: #ecf0f1;
  }

  .score-board {
    margin-bottom: 15px;
    font-size: 1em;
    background: rgba(0, 0, 0, 0.2);
    display: inline-block;
    padding: 8px 15px;
    border-radius: 20px;
  }

  .score-divider {
    margin: 0 10px;
    opacity: 0.5;
  }

  /* The Simon Grid */
  .simon-board {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 10px;
    max-width: 300px;
    height: 300px;
    margin: 0 auto 20px auto;
  }

  .color-btn {
    border: none;
    border-radius: 15px;
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.1s, transform 0.1s;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    /* For removing tap highlight on mobile */
    -webkit-tap-highlight-color: transparent;
  }

  /* Color specific styles */
  .btn-green { background-color: #2ecc71; border-top-left-radius: 100px; }
  .btn-red { background-color: #e74c3c; border-top-right-radius: 100px; }
  .btn-yellow { background-color: #f1c40f; border-bottom-left-radius: 100px; }
  .btn-blue { background-color: #3498db; border-bottom-right-radius: 100px; }

  /* Active/Flash state */
  .color-btn.active {
    opacity: 1;
    transform: scale(0.98);
    box-shadow: 0 0 15px white;
  }

  /* Controls */
  .controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .game-btn {
    padding: 10px 20px;
    font-size: 1em;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    background-color: #ecf0f1;
    color: #2c3e50;
    transition: background 0.2s;
  }

  .game-btn:hover {
    background-color: #bdc3c7;
  }

  .game-btn:disabled {
    background-color: #95a5a6;
    cursor: not-allowed;
  }
</style>

<div class="game-container">
  <div class="game-header">
    <h2>{{ game_title }}</h2>
    <div class="score-board">
      {{ score_label }} <span id="score-val">0</span>
      <span class="score-divider">|</span>
      {{ high_score_label }} <span id="high-score-val">0</span>
    </div>
    <div class="game-status" id="status-text">{{ status_start }}</div>
  </div>

  <div class="simon-board">
    <button class="color-btn btn-green" id="green"></button>
    <button class="color-btn btn-red" id="red"></button>
    <button class="color-btn btn-yellow" id="yellow"></button>
    <button class="color-btn btn-blue" id="blue"></button>
  </div>

  <div class="controls">
    <button class="game-btn" id="start-btn">{{ btn_start }}</button>
    <button class="game-btn" id="mute-btn">{{ sound_on }}</button>
  </div>
</div>

<script>
  (function() {
    // --- Configuration Variables ---
    const TEXT_START = '{{ status_start }}';
    const TEXT_WATCH = '{{ status_watch }}';
    const TEXT_PLAY = '{{ status_play }}';
    const TEXT_GAMEOVER = '{{ status_gameover }}';
    const TEXT_NEWRECORD = '{{ status_newrecord }}';
    const BTN_RESTART = '{{ btn_restart }}';
    const BTN_START = '{{ btn_start }}';
    const TXT_SOUND_ON = '{{ sound_on }}';
    const TXT_SOUND_OFF = '{{ sound_off }}';
    const STORAGE_KEY = 'simon_game_high_score';

    // --- Game State ---
    let gameSequence = [];
    let playerSequence = [];
    let score = 0;
    let highScore = 0;
    let isGameActive = false;
    let isComputerTurn = false;
    let isMuted = false;
    
    // --- Audio Context Setup ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const frequencies = [261.63, 293.66, 329.63, 349.23]; // C4, D4, E4, F4

    // --- DOM Elements ---
    const startBtn = document.getElementById('start-btn');
    const muteBtn = document.getElementById('mute-btn');
    const statusText = document.getElementById('status-text');
    const scoreVal = document.getElementById('score-val');
    const highScoreVal = document.getElementById('high-score-val');
    const buttons = [
      document.getElementById('green'),  // 0
      document.getElementById('red'),    // 1
      document.getElementById('yellow'), // 2
      document.getElementById('blue')    // 3
    ];

    // --- Initialization ---
    function init() {
      // Load high score from local storage
      const storedScore = localStorage.getItem(STORAGE_KEY);
      if (storedScore) {
        highScore = parseInt(storedScore, 10);
        highScoreVal.innerText = highScore;
      }
    }

    // --- Sound Logic ---
    function playTone(index) {
      if (isMuted) return;
      if (audioCtx.state === 'suspended') audioCtx.resume();

      const osc = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();

      osc.type = 'sine';
      osc.frequency.value = frequencies[index];
      
      osc.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);

      osc.start();
      osc.stop(audioCtx.currentTime + 0.5);
    }

    // --- Game Logic ---
    function startGame() {
      gameSequence = [];
      playerSequence = [];
      score = 0;
      scoreVal.innerText = score;
      isGameActive = true;
      startBtn.disabled = true;
      statusText.innerText = TEXT_WATCH;
      
      // Delay slightly before starting
      setTimeout(nextRound, 500);
    }

    function nextRound() {
      playerSequence = [];
      scoreVal.innerText = score;
      isComputerTurn = true;
      statusText.innerText = TEXT_WATCH;

      const nextColor = Math.floor(Math.random() * 4);
      gameSequence.push(nextColor);

      playSequence();
    }

    function playSequence() {
      let i = 0;
      const interval = setInterval(() => {
        if (i >= gameSequence.length) {
          clearInterval(interval);
          isComputerTurn = false;
          statusText.innerText = TEXT_PLAY;
          return;
        }
        flashButton(gameSequence[i]);
        i++;
      }, 800);
    }

    function flashButton(index) {
      const btn = buttons[index];
      btn.classList.add('active');
      playTone(index);
      setTimeout(() => {
        btn.classList.remove('active');
      }, 400);
    }

    function handlePlayerInput(index) {
      if (!isGameActive || isComputerTurn) return;

      flashButton(index);
      playerSequence.push(index);

      // Check correctness
      const currentMoveIndex = playerSequence.length - 1;
      if (playerSequence[currentMoveIndex] !== gameSequence[currentMoveIndex]) {
        gameOver();
        return;
      }

      // Check if round complete
      if (playerSequence.length === gameSequence.length) {
        score++;
        isComputerTurn = true; 
        setTimeout(nextRound, 1000);
      }
    }

    function gameOver() {
      isGameActive = false;
      
      // Check for High Score
      if (score > highScore) {
        highScore = score;
        highScoreVal.innerText = highScore;
        localStorage.setItem(STORAGE_KEY, highScore);
        statusText.innerText = TEXT_NEWRECORD;
      } else {
        statusText.innerText = TEXT_GAMEOVER;
      }

      startBtn.innerText = BTN_RESTART;
      startBtn.disabled = false;
      
      // Error Sound
      if (!isMuted) {
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.value = 150; 
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.8);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.8);
      }
    }

    // --- Event Listeners ---
    buttons.forEach((btn, index) => {
      btn.addEventListener('click', () => handlePlayerInput(index));
    });

    startBtn.addEventListener('click', startGame);

    muteBtn.addEventListener('click', () => {
      isMuted = !isMuted;
      muteBtn.innerText = isMuted ? TXT_SOUND_OFF : TXT_SOUND_ON;
    });

    // Run init
    init();

  })();
</script>