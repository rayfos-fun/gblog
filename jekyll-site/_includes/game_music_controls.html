<!-- Game Music Controls -->
{% assign music_on_label = "Music: On" %}
{% assign music_off_label = "Music: Off" %}
{% assign volume_label = "Volume:" %}

{% if page.lang == 'zh-tw' %}
{% assign music_on_label = "音樂: 開啟" %}
{% assign music_off_label = "音樂: 關閉" %}
{% assign volume_label = "音量:" %}
{% elsif page.lang == 'zh-cn' %}
{% assign music_on_label = "音乐: 开启" %}
{% assign music_off_label = "音乐: 关闭" %}
{% assign volume_label = "音量:" %}
{% endif %}

<div class="game-music-controls"
    style="margin-bottom: 20px; padding: 10px; background: #eee; border-radius: 8px; display: flex; align-items: center; gap: 15px;">
    <button id="globalBgmToggle"
        style="padding: 5px 15px; cursor: pointer; border: none; border-radius: 4px; color: white;">{{
        music_off_label }}</button>
    <label style="display: flex; align-items: center; gap: 5px;">
        {{ volume_label }}
        <input type="range" id="globalBgmVolume" min="0" max="1" step="0.1" value="0.5" style="width: 100px;">
    </label>
    <audio id="globalBgmAudio" loop>
        <source src="https://storage.googleapis.com/rayfos-bucket/background.mp3" type="audio/mpeg">
    </audio>
</div>

<script>
    (function () {
        const audio = document.getElementById('globalBgmAudio');
        const btn = document.getElementById('globalBgmToggle');
        const vol = document.getElementById('globalBgmVolume');

        const uiText = {
            on: "{{ music_on_label }}",
            off: "{{ music_off_label }}"
        };

        if (!audio || !btn || !vol) return;

        // Load settings from localStorage
        // Default to false (off) per user request "initially music is off"
        let enabled = localStorage.getItem('bgm_enabled') === 'true';
        let volume = parseFloat(localStorage.getItem('bgm_volume') || '0.5');

        // Apply initial state
        audio.volume = volume;
        vol.value = volume;
        updateUI();

        // If enabled is true (from previous session), try to auto-play
        if (enabled) {
            playAudio();
        }

        // Event Listeners
        btn.addEventListener('click', () => {
            enabled = !enabled;
            localStorage.setItem('bgm_enabled', enabled);
            updateUI();

            if (enabled) {
                playAudio();
            } else {
                audio.pause();
            }
        });

        vol.addEventListener('input', (e) => {
            volume = e.target.value;
            audio.volume = volume;
            localStorage.setItem('bgm_volume', volume);
        });

        function updateUI() {
            if (enabled) {
                btn.innerText = uiText.on;
                btn.style.backgroundColor = '#27ae60';
            } else {
                btn.innerText = uiText.off;
                btn.style.backgroundColor = '#7f8c8d';
            }
        }

        function playAudio() {
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log('Auto-play was prevented:', error);
                    // Fallback: Wait for first user interaction
                    const resumeAudio = () => {
                        audio.play();
                        document.removeEventListener('click', resumeAudio);
                        document.removeEventListener('keydown', resumeAudio);
                    };
                    document.addEventListener('click', resumeAudio);
                    document.addEventListener('keydown', resumeAudio);
                });
            }
        }
    })();
</script>